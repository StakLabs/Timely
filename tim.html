<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Timely</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: #111;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        input#ask {
            width: 90%;
            max-width: 600px;
            padding: 15px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            background: #222;
            color: #fff;
            outline: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s ease-in-out;
        }
        input#ask:focus {
            background: #333;
            box-shadow: 0 0 15px #00f2ff;
        }
        #response {
            margin-top: 20px;
            padding: 20px;
            width: 90%;
            max-width: 700px;
            background: #1a1a1a;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #333;
        }
        h1#heading {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #00f2ff;
            text-shadow: 0 0 10px #00f2ff, 0 0 20px #00f2ff55;
            animation: pulseGlow 2s infinite ease-in-out;
        }
        @keyframes pulseGlow {
            0%, 100% {
                text-shadow: 0 0 10px #00f2ff, 0 0 20px #00f2ff55;
            }
            50% {
                text-shadow: 0 0 20px #00f2ff, 0 0 30px #00f2ffaa;
            }
        }
    </style>
</head>
<body>
    <h1 id="heading">ü§ñ T.I.M Console: Deploy Your Task to Time</h1>
    <input id="ask" onkeydown="if (event.key === 'Enter') askOpenAI(this.value)">
    <p id="response"></p>

    <script>
        const user = JSON.parse(localStorage.getItem('savedUser'));

        async function getSchedulesByEmail(email) {
            return await fetch(`https://timely-zc0n.onrender.com/items/${encodeURIComponent(email)}`)
                .then(res => res.json())
                .catch(err => {
                    console.error('Error fetching schedules:', err);
                    return [];
                });
        }

        async function askOpenAI(prompt) {
            if (!user) {
                alert('User not logged in');
                return;
            }

            const todaysDate = new Date().toLocaleDateString();
            const schedules = JSON.stringify(await getSchedulesByEmail(user.email));
            const systemPrompt = `
                Your are T.I.M -> Timely Intelligence Mechanism
                Your job is to transform what someone says into integratable schedules
                NEVER reply with words unless there is not enough information or they are asking what they have in their schedule, instead, DO NOT include any explanations, extra text, or formatting. If multiple items are mentioned, return them in a JSON array.
                Your object could look like this for instance:
                {"id":"1","username":"user.username","email":"user.email","password":"user.password","itemName":"Make dua","itemDescription":"any dua","itemDate":"2025-07-05T00:00:00.000Z","itemStart":"18:00","itemEnd":null,"itemCategory":"other"}
                replace the username with user.username and replace password with user.password and replace the email with user.email
                The object must include EVERY FIELD -> username, password, email, id, itemName, itemDescription, itemDate, itemStart, itemEnd and itemCategory
                If the user includes details for multiple items, make multiple objects and store them in an array.
                if there is not enough information, tell that to the user (not in json format) and remember to include the word 'information' in that response.
                The ID for the item should just be a random number from 0 to 999999999 please.
                THE DESCRIPTION SHOULD NOT BE MORE THAN 4 WORDS AND THE NAME SHOULD NOT BE MORE THAN 2 WORDS!
                If they did not provide a description, or there are limited datails, the description should be 'No description provided'.
                The only categories are work, personal, shopping, to-do and other
                NEVER GUESS VALUES! IF THERE IS NOT ENOUGH INFORMATION, SAY SO BUT DO NOT SAY IT IN JSON FORMAT.
                Todays date is ${todaysDate} and i am giving you this imformation so when the user says they have to do something for tomorrow or next week or something like that, you know what to add as the date, you simply add days to the date
                The users schedule is ${schedules}, use this information when they ask for their items, tasks or schedules.
                if the user asks what they have on their schedules, TELL THEM IN WORDS they have ${schedules} but DO NOT GIVE THEM AN ARRAY OR OBJECT, ONLY WORDS and tell them the time and description of needed.
                Never include any backend error or connection issues as part of the response.
            `;

            document.getElementById('response').innerText = 'Thinking...';

            try {
                const res = await fetch('https://timely-2.onrender.com/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, system: systemPrompt })
                });

                const data = await res.json();
                let reply = data.choices?.[0]?.message?.content;

                if (!reply) {
                    document.getElementById('response').innerText = 'No response from AI ü§ñ';
                    return;
                }

                // Catch backend errors that accidentally get sent in the message
                if (
                    reply.toLowerCase().includes('connection is in closed state') ||
                    reply.includes('"message":') && reply.toLowerCase().includes('connection')
                ) {
                    console.warn('AI returned a backend error instead of a proper response:', reply);
                    document.getElementById('response').innerText = '‚ö†Ô∏è Error occurred on the server. Try again!';
                    return;
                }

                // If it's natural language only, show it and bounce
                if (!reply.trim().startsWith('{') && !reply.trim().startsWith('[')) {
                    document.getElementById('response').innerText = reply;
                    return;
                }

                // Replace placeholders
                reply = reply.replace(/user\.username/g, user.username);
                reply = reply.replace(/user\.email/g, user.email);
                reply = reply.replace(/user\.password/g, user.password);

                document.getElementById('response').innerText = 'Processing Information...';

                const parsed = extractJSONFromString(reply);
                if (!parsed) {
                    document.getElementById('response').innerText = 'Could not extract valid schedule üòµ';
                    return;
                }

                if (Array.isArray(parsed)) {
                    for (const item of parsed) {
                        await addScheduleToBackend(item);
                    }
                } else {
                    await addScheduleToBackend(parsed);
                }

            } catch (err) {
                console.error('Request failed:', err);
                document.getElementById('response').innerText = 'Error contacting backend ü•≤';
            }
        }

        async function addScheduleToBackend(schedule) {
            // Validate schedule structure
            if (
                !schedule || typeof schedule !== 'object' ||
                !schedule.itemName || !schedule.itemDescription || !schedule.itemDate ||
                !schedule.itemStart || !schedule.itemCategory
            ) {
                console.warn('Skipping invalid schedule object:', schedule);
                document.getElementById('response').innerText = 'Invalid task object detected and skipped üôÖ‚Äç‚ôÇÔ∏è';
                return;
            }

            try {
                const res = await fetch('https://timely-zc0n.onrender.com/items/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(schedule)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error(`Failed to add schedule: ${res.status} - ${errorText}`);
                    throw new Error('Failed to add schedule');
                }

                document.getElementById('response').innerText = 'Item added successfully!';
                return await res.json();

            } catch (err) {
                console.error('Error in addScheduleToBackend:', err);
                document.getElementById('response').innerText = 'Backend error. Try again?';
                return null;
            }
        }

        function extractJSONFromString(str) {
            const arrayRegex = /\[\s*{[\s\S]*?}\s*\]/g;
            const objectRegex = /{[\s\S]*?}/g;

            try {
                const arrayMatch = str.match(arrayRegex);
                if (arrayMatch) return JSON.parse(arrayMatch[0]);
            } catch (e1) {}

            try {
                const objectMatch = str.match(objectRegex);
                if (objectMatch) return JSON.parse(objectMatch[0]);
            } catch (e2) {}

            console.error("Failed to extract JSON from string");
            return null;
        }
    </script>
</body>
</html>
